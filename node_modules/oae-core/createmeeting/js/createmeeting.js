define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings, widgetData) {

        // The widget container
        var $rootel = $('#' + uid);
	var visibility = oae.api.config.getValue('oae-discussions', 'visibility', 'discussion');
	var setPermissionsId = oae.api.util.generateId();
	var members = [];

        var setUpReset = function() {
            $('#createmeeting-modal', $rootel).on('hidden', function (evt) {
                // Reset the form
                var $form = $('#createmeeting-form', $rootel);
                $form[0].reset();
                oae.api.util.validation().clear($form);
                showOverview();
		console.log("en setupreset");

                // Unbind the setpermissions handler
                $(document).off('oae.setpermissions.changed.' + setPermissionsId);
            });
        };

	var showOverview = function() {
            // Hide all containers
            $('.modal-body > div:visible', $rootel).hide();
            // Show the overview container
            $('#createmeeting-form > .modal-footer', $rootel).show();
            $('#createmeeting-overview-container', $rootel).show();
		console.log("showOverview");
        };
	
	var setUpSetPermissions = function() {
            // Remove the previous `setpermissions` widget
            var $setPermissionsContainer = $('#createmeeting-permissions-container', $rootel);
            $setPermissionsContainer.html('');
		console.log("setupsetpermissions");
            // Event that will be triggered when permission changes have been made in the `setpermissions` widget.
            $(document).on('oae.setpermissions.changed.' + setPermissionsId, function(ev, data) {
                // Update visibility for document
                visibility = data.visibility;
                $(data.viewers).each(function(index, member) {
                    members.push(member.id);
                });
                // Render the sharing and visibility summary
                $('#createmeeting-permissions-summary', $rootel).html(data.summary);
                // Switch back to the overview
                showOverview();
            });

            // Event that will be triggered when permission changes have been cancelled
            $(document).on('oae.setpermissions.cancel.' + setPermissionsId, showOverview);

            // Load the `setpermissions` widget into its container
            oae.api.widget.insertWidget('setpermissions', setPermissionsId, $setPermissionsContainer, false, {
                'count': 1,
                'type': 'meeting',
                'visibility': visibility
            });
        };


        var createMeeting = function() {
		$(document).on('click', '.oae-trigger-createmeeting', function() {
		   $('#createmeeting-modal', $rootel).modal({
                    'backdrop': 'static'
                });
            });

            $('#createmeeting-modal', $rootel).on('shown', function() {
                // IE10 has a problem where it treats the placeholder text as the textarea's
                // value. Therefore, we need to explicitly clear the value of the textarea to
                // make the placeholder behave like a placeholder.
                // @see https://github.com/oaeproject/3akai-ux/pull/2906
                $('#createmeeting-topic', $rootel).val('');
                // Set focus to the discussion topic field
                $('#createmeeting-name', $rootel).focus();

                // Initiate the permissions widget
                setUpSetPermissions();
            });

            // Binds the 'change' button that shows the setpermissions widget
            $('#createmeeting-change-permissions', $rootel).on('click', function(){

		// Hide all containers
            		$('.modal-body > div:visible', $rootel).hide();
            		$('#createmeeting-form > .modal-footer', $rootel).hide();
            		// Show the permissions container
            		$('#createmeeting-permissions-container', $rootel).show();
	    		console.log("showPermissions");
		});
        };

	createMeeting();
	setUpReset();
  		
	};
	
	
})