

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings, widgetData) {
	
        // The widget container
        var $rootel = $('#' + uid);
	var visibility = oae.api.config.getValue('oae-bbb', 'visibility', 'meeting');
	var setPermissionsId = oae.api.util.generateId();
	var members = [];
	
        var setUpReset = function() {
            $('#createmeeting-modal', $rootel).on('hidden', function (evt) {
                // Reset the form
                var $form = $('#createmeeting-form', $rootel);
                $form[0].reset();
                oae.api.util.validation().clear($form);
                showOverview();
		// Unbind the setpermissions handler
                $(document).off('oae.setpermissions.changed.' + setPermissionsId);
            });
        };

	var showOverview = function() {
            // Hide all containers
            $('.modal-body > div:visible', $rootel).hide();
            // Show the overview container
            $('#createmeeting-form > .modal-footer', $rootel).show();
            $('#createmeeting-overview-container', $rootel).show();
		
        };
	
	var setUpSetPermissions = function() {
            // Remove the previous `setpermissions` widget
            var $setPermissionsContainer = $('#createmeeting-permissions-container', $rootel);
            $setPermissionsContainer.html('');
		// Event that will be triggered when permission changes have been made in the `setpermissions` widget.
            $(document).on('oae.setpermissions.changed.' + setPermissionsId, function(ev, data) {
                // Update visibility for document
                visibility = data.visibility;
                $(data.viewers).each(function(index, member) {
                    members.push(member.id);
                });
                // Render the sharing and visibility summary
                $('#createmeeting-permissions-summary', $rootel).html(data.summary);
                // Switch back to the overview
                showOverview();
            });

            // Event that will be triggered when permission changes have been cancelled
            $(document).on('oae.setpermissions.cancel.' + setPermissionsId, showOverview);

            // Load the `setpermissions` widget into its container
            oae.api.widget.insertWidget('setpermissions', setPermissionsId, $setPermissionsContainer, false, {
                'count': 1,
                'type': 'meeting',
                'visibility': visibility
            });
        };


        var createMeetingModal = function() {
		$(document).on('click', '.oae-trigger-createmeeting', function() {
		   $('#createmeeting-modal', $rootel).modal({
                    'backdrop': 'static'
                });
            });

            $('#createmeeting-modal', $rootel).on('shown', function() {
                
                $('#createmeeting-topic', $rootel).val('');
                $('#createmeeting-name', $rootel).focus();

                // Initiate the permissions widget
                setUpSetPermissions();
            });

            // Binds the 'change' button that shows the setpermissions widget
            $('#createmeeting-change-permissions', $rootel).on('click', function(){

		// Hide all containers
            		$('.modal-body > div:visible', $rootel).hide();
            		$('#createmeeting-form > .modal-footer', $rootel).hide();
            		// Show the permissions container
            		$('#createmeeting-permissions-container', $rootel).show();
		});
        };
	
	 var createMeeting = function() {
        
         $('#createmeeting-create').on('click',function(){   
		$('#createmeeting-form *', $rootel).prop('disabled', true);
		
          	var displayName = $.trim($('#createmeeting-name', $rootel).val());
            	var description = $.trim($('#createmeeting-topic', $rootel).val());
	   	var welcomemessage = $.trim($('#createmeeting-welcomemessage', $rootel).val());

            	//console.log(displayName+ meetingTopic+welcomeMessage);

		$.ajax({
			'type': "POST",
    			'url': '/api/meeting/create',
    			'data': {	
					displayName : displayName,
					description: description,
					welcomemessage: welcomemessage
			  },
   			'success': function() { 
				location.reload();
			},
   			'error': function() { alert('Meeting has not been created! :('); }
		});
	});
		
	};
	
	
	createMeeting();
	createMeetingModal();
	setUpReset();
  		
	};
	
	
})