
define(['jquery', 'oae.core', 'oae.api'], function($, oae) {

	return function(uid, showSettings, widgetData) {
		var $rootel = $('#' + uid);
		
		var init = function(){
			var userID = widgetData.context.id;
			$.ajax({
				'type': "POST",
    				'url': '/api/meeting',
    				'data': {userID: userID},
   				'success': function(data) { 
					parsingData(data);
					console.log(data[0]);
				},
   				'error': function() { alert('There are no meetings'); }
			});	
		};

		var parsingData = function(data){
			
			for(var i=0;i<data.length;i++){
       			var obj = data[i];
				var div = document.createElement('div');
				var camera = document.createElement('div');
				var button = document.createElement('button');
				var plus = document.createElement('i');
				$(button).attr('type','button');
				$(button).attr('class','btn');
				
				$(camera).attr('class', 'camera-wrapper camera-wrapper-large icon-camera');
        			
				for(var key in obj){
            		var attrName = key;
            		var attrValue = obj[key];
					
					if(attrValue["value"]){
						if(attrValue["name"]=="id"){
							//$(div).attr('id',attrValue["value"]);
							$(button).attr('id',attrValue["value"]);
							$(button).on('click',{meetingID : attrValue["value"]},createBBBCall);
						}
						if(attrValue["name"]=="displayName"){
							$(button).append(attrValue["value"]);
							$(button).attr("meetingname",attrValue["value"]);
						}
						if(attrValue["name"]=="record")
							$(button).attr("record",attrValue["value"]);
						if(attrValue["name"]=="duration")
							$(button).attr("duration",attrValue["value"]);
						if(attrValue["name"]=="welcomeMessage")
							$(button).attr("welcomeMessage",attrValue["value"]);	
					}
				}
				$(camera).append(button);
				$(div).append(camera);
				$('#meetings').append(div);
    		}
		};
	
		var createBBBCall = function(event){
			var meetingID = event.data.meetingID;
			var button = document.getElementById(meetingID);
			var displayName = oae.data.me.displayName;
			var name = displayName.split(' ')[0];
			var meetingname = button.getAttribute("meetingname");
			var duration = button.getAttribute("duration");
			var record = button.getAttribute("record");
			var welcomeMessage = button.getAttribute("welcomeMessage");
			
			$.ajax({
				'type': "POST",
    				'url': '/api/create',
    				'data': {	
					meetingID : meetingID,
					name : name,
					duration: duration,
					record: record,
					welcomeMessage: welcomeMessage,
					meetingname : meetingname
			  	},
   				'success': function(data) { 
					window.open(data);
				},
   				'error': function() { alert('Cannot join meeting'); }
			});
		};
	init();
	};
})